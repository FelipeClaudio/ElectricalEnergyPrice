\paragraph{}O objetivo deste capitulo é descrever o método utilizado no desenvolvimento do trabalho. Será descrito o fluxo de dados utilizado na previsão do PLD. Isso inclui o pré-processamento dos dados e o treinamento das redes neurais.

\section{Coleta de dados}
\paragraph{}Serão utilizados nos modelos os seguintes dados do setor elétrico. Todos os dados da tabela \ref{table:DadosDeEntrada} estão disponíveis publicamente e são séries temporais com intervalo de amostragem de 1 mês.:

\paragraph{}No início do trabalho definiu-se que o foco seria a região sudeste, sendo assim, todos os dados utilizados foram filtrados para a região SE/CO. Os dados provenientes da ONS foram baixados direto do site no formato \textit{Comma Separated Values} - CSV.

\paragraph{}Para facilitar o processamento, serão retiradas todas as colunas que não fossem a data no formato "mês (por extenso) ano". Então, essas serão renomeadas para \textit{month} e \textit{value} e o valor do dado referido (ex: MWh produzidos por usinas hidroelétricas no mês), facilitando o desenvolvimento do código. 

\paragraph{}Dado que as regras para o cálculo do PLD variam durante os anos, serão utilizados somente os dados para o período entre 01/2015 e 12/2018, de modo a tentar reduzir ao máximo esse efeito. Sendo assim, o conjunto de dados possuirá um total de 48 pontos.

\begin{table}[H]	
	\begin{center}
		\caption{Dados utilizado no trabalho.}	
		\begin{tabular}{|c|c|c|}\hline \label{table:DadosDeEntrada}
			\textbf{Dado} & \textbf{Tipo} & \textbf{Fonte}\\ \hline \vspace{-1.0mm}
			
			PLD & Saída & CCEE \cite{CCEE}  \\ \hline
			Energia Total Armazenada & Entrada & ONS \cite{ONS}  \\ \hline
			Energia Gerada pelas Usinas Hidroelétricas & Entrada & ONS \cite{ONS}  \\ \hline
			Energia Gerada pelas Usinas Térmicas & Entrada & ONS \cite{ONS}  \\ \hline
			Energia Gerada pelas Usinas Solares & Entrada & ONS \cite{ONS}  \\ \hline
			Energia Gerada pelas Usinas Eólicas & Entrada & ONS \cite{ONS}  \\ \hline
			Energia de Carga & Entrada & ONS \cite{ONS}  \\ \hline
			Energia Natural Afluente & Entrada & ONS \cite{ONS}  \\ \hline
			Soma das Vazões Afluentes & Entrada & CCEE \cite{CCEE} \\ \hline
			Valor Útil da Soma das Vazões Afluentes & Entrada & CCEE \cite{CCEE} \\ \hline
		\end{tabular}		
	\end{center}
\end{table}

\paragraph{}Os dados do PLD são fornecidos no formato tabelar no site da CCEE\cite{CCEE}, assim como visto na figura \ref{PLDCCEESite}. Sendo assim, os dados que interessantes ao problema serão copiados para uma planilha e importados no por um código python usando a biblioteca Pandas\cite{Pandas}.

\paragraph{}Os dados da ONS serão retirados de uma aplicação online com Tableau para visualizar os dados, assim como visto na figura \ref{dadosONS}. Os dados serão então extraídos no formato CSV. Após a extração, serão removidas as colunas que não são necessárias para a análise que será feita. Ao final sobrarão duas colunas, sendo que uma será nomeada "month" e terá a informação sobre o mês relacionado ao dado. A outra coluna será nomeada como "value", e trará o valor numérico do dados que está sendo analisado. Ao final do processo, a planilha será importada pelo código python préviamente citado.

\paragraph{}Para o cálculo da soma das vazões, será utilizado o arquivo VAZOES.DAT fornecido pela CCEE. Este arquivo é binário e para ser lido precisa da utilização do executável vazedit também fornecido pela CCEE, visto na figura \ref{vazedit}. Após o processamento deste programa, obtém-se um arquivo texto com as vazões de cada posto fluviométrico para cada mês em cada ano desde de 1931, assim como exibido na figura \ref{vazoesTxt}. Esses valores foram somados para os postos que pertencem exclusivamente à região Sudeste.

\paragraph{}O "valor útil da soma das vazões afluentes" é um cálculo semelhante ao descrito no parágrafo anterior, porém removendo em cada posto a vazão mínima necessária para a produção de energia. Para obter essa informação, será utilizado o arquivo HIDR.DAT, também fornecido pela CCEE, o qual possui o cadastro de todas as usinas consideradas nos cálculos do PLD. Assim como no caso do arquivo VAZOES.DAT, o HIDR.DAT também é binário. Para processar o mesmo será necessário um executável também fornecido pela CCEE chamado hydroedit, visto na figura \ref{hydroedit}. 

\paragraph{}Os resultados, já no formato texto, serão lidos pelo arquivo python. A inconsistência observado nos dados para o ano de 1931 será removida por meio de código. Além disso, será necessário filtrar os postos, também por meio do código, para só importar dados do subsistema SE/CO. 

\begin{figure}[H]
	\begin{center}
		{
			\begin{center}
				
				\includegraphics[height=0.6\textwidth]{pld_ccee.png}		
				\caption[\small{Tabela de PLD médio na CCEE}]{\label{PLDCCEESite}\small{Tabela de PLD médio na CCEE\cite{CCEE}}}
				
			\end{center}
			
		}	
	\end{center}	
\end{figure}

\begin{figure}[H]
	\begin{center}
		{
			\begin{center}
				
				\includegraphics[height=0.6\textwidth]{dados_ons.png}		
				\caption[\small{Histórico de geração de energia elétrica entre 2015 e 2019 segundo ONS}]{\label{dadosONS} \small{Histórico de geração de energia elétrica entre 2015 e 2019 segundo ONS\cite{ONS}}}
				
			\end{center}
			
		}	
	\end{center}	
\end{figure}

\begin{figure}[H]
	\centering
	\begin{subfigure}{.47\textwidth}
		\centering
			\includegraphics[height=0.75\textwidth]{vazedit.png}		
			\caption[\small{Interface Vazedit}]{\label{vazedit} \small{Interface Vazedit}}
	\end{subfigure}
	\begin{subfigure}{.47\textwidth}
		\centering
			\includegraphics[height=0.75\textwidth]{vazoes.png}		
			\caption[\small{Arquivo de vazões no formato texto}]{\label{vazoesTxt} \small{Arquivo de vazões no formato texto}}
	\end{subfigure}
	\caption{Previsão do PLD utilizando o modelo híbrido}		
\end{figure}


\begin{figure}[H]
	\begin{center}
		{
			\begin{center}
				
				\includegraphics[height=0.35\textheight]{hydroedit.png}		
				\caption[\small{Hydroedit sendo usado para converter o as informações sobre as usinas para o formato csv}]{\label{hydroedit} \small{Hydroedit sendo usado para converter o as informações sobre as usinas para o formato csv}}
					
			\end{center}
				
		}	
	\end{center}	
\end{figure}    

\section{Pré-processamento}
\paragraph{}A etapa de pré-processamento descrita nessa seção foi aplicada tanto nos sinais de entrada quanto na saída. Busca-se decompor o sinal conforme mencionado em \ref{series_temporais}. Ao final do processamento, o sinal $X_t$ poderá ser obtido através das soma dos sinais extraídos, assim como visto na formula a seguir: $X_t = tend_t + sz_t + cs_t + res_t$. O primeiro passo a ser realizado é a extração da tendência.

\subsection{Tendência}
\paragraph{} Dado o tamanho reduzido da série temporal, não foi possível aplicar a média móvel diretamente pois isso implicaria na perda de alguns pontos da série. Sendo assim, utilizou-se uma abordagem híbrida na extração da tendência onde as primeiras amostras são obtidas através de uma regressão linear e a média móvel é usada no restante da série. A transição entre os dois métodos costuma ser bastante brusca, gerando altas frequências na transformada de Fourier. A solução para esse novo problema foi implentar um transição gradual entre os métodos de extração. O processamento realizado na obtenção da tendência pode ser visto na fórmula abaixo:

\begin{equation} \label{maLinFit}
\hat{y} = \begin{cases}
X_i, & \mbox{se } i \leq 2\\

LR(1, X_i), & \mbox{se } 2 < i < W \\

\alpha LR(1, X_W) + (1 - \alpha) MA(W), & \mbox{se } W \leq i < W + K\\

MA(W), & \mbox{se } i \geq W + K

\end{cases}
\end{equation}

\paragraph{}Para um filtro de média de comprimento $W$ com $K$ passos de transição e com $0 \leq \alpha \leq 1 $ proporcional ao número de passos de transição, define-se o filtro acima para resolver o problema da falta de pontos para realizar a média móvel. LR se refere à regressão linear e MA refere-se à média móvel e a qual é definida pela seguinte equação:
\begin{equation}
MA(W) = \dfrac{1}{W + 1} \sum_{j = -W}^{0} x_{t+j}  
\end{equation}

\paragraph{}A outra proposta de extração de tendência utilizada foi a seguinte:
\begin{equation} \label{maOnly}
\hat{y} = \begin{cases}
X_i, & \mbox{se } i \leq W\\

MA(W), & \mbox{se } i > W

\end{cases}
\end{equation}

\paragraph{}As duas fórmulas acima dependem do parâmetro ($W$) o qual varia conforme o problema a ser resolvido. A escolha do $W$ foi feita a partir da análise do MSE pelo tamanho da janela. Como o objetivo é obter uma função que tenha a capacidade de prever a tendência um passo à frente com o mínimo erro possível, busca-se um valor de $W$ que não seja pequeno demais (pouca capacidade de generalização) nem muito grande (pouco sensível às variações).

\subsection{Sazonalidade}
\paragraph{}Após a extração da tendência, o sinal restante é descrito pela seguinte fórmula: $s_{1t} = sz_t + cs_t + res_t$. A o método de extração é similar ao descrito acima, porém, no caso da sazonalidade a série é decimada conforme um parâmetro T que indica o valor do atraso temporal utilizado.

\paragraph{}As fórmulas utilizadas na extração da sazonalidade foram as seguintes:
\begin{equation} \label{linFitSz}
\hat{y} = \begin{cases}
X_{RESTO(i/T)}, & \mbox{se } i \leq 2T\\

LR(1, X^{*}), & \mbox{se } i > 2T 
\end{cases}
\end{equation}

\begin{equation} \label{maSz}
\hat{y} = \begin{cases}
X_{RESTO(i/T)}, & \mbox{se } i \leq 2T\\

MA(1, X^{*}), & \mbox{se } i > 2T 
\end{cases}
\end{equation}

\paragraph{}Onde $X^{*}$ é o conjunto composto por todas as amostras em um determinado instante onde $RESTO(i/T) = 0$.

\paragraph{} Em \ref{linFitSz} utiliza-se a regressão linear dos pontos decimados para tentar prever a sazonalidade, já em \ref{maSz} utiliza-se a média móvel. Em ambos os casos utilizam-se todos os pontos fornecidos ao filtro como base para a previsão, eliminando o problema de selecionar o parâmetro $W$. Todavia, ainda existe o problema de selecionar o valor correto do parâmetro $T$ para que se obtenha o menor erro possível na extração da componente sazonal.

\subsection{Ciclos Senoidais e Resíduo}
\paragraph{}O ciclo senoidal será obtido através da seleção do maior pico na transformada de Fourier do sinal. Para a extração do mesmo será utilizado o filtro Notch. O resultado dessa operação é um sinal composto somente pela componente residual. Esta é a parte não determinística da série. Finalmente o sinal é normalizado utilizando a técnica \textit{MinMaxScaler} \cite{minMaxScaler}.

\section{Seleção dos sinais de entrada}
\paragraph{}A seleção dos sinais de entrada será feita através do gráfico de correlação dos mesmos. Buscou-se sinais com alta correlação, para que pudesse ser removido um dos pares, visto que isso é um indicativo de que há uma redundância na informação fornecida no modelo. A remoção dos sinais com alta correlação diminui o tempo de treinamento e também pode diminuir o ruído na entrada, fazendo assim com que o treinamento tenha uma precisão maior.

\subsection{Seleção dos atrasos do sinal de saída}
\paragraph{}A entrada do modelo é composta por sinais no tempo atual e sinais defasados em períodos de tempo específicos. A seleção das defasagens será feita através do cálculo da autocorrelação do sinal de saída. Todos os valores com autocorrelação maior ou próximo do limite do intervalo de 95\% de confiança foram selecionados. Os valores de defasagem foram replicados para todos os sinais utilizados na entrada do modelo.

\section{Rede Neural}
\paragraph{}Foi definido que a rede neural utilizada será um MLP de uma camada escondida somente, com ReLU \ref{relu} como função de ativação. A saída conterá somente um neurônio com função de ativação linear, de modo a conseguir obter o sinal utilizado na previsão do resíduo do PLD.

\subsection{Treinamento das redes neurais} \label{treinamentoRedes}
\paragraph{}O treinamento será realizado modificando o número de neurônios na camada intermediária, de forma a avaliar qual arquitetura fornece o menor erro na saída. Para a avaliação dos resultados será utilizado como métrica o RMSE no conjunto de validação pelo número de neurônios. Outro critério para a avaliação utilizado também será o gráfico de pontos do dado previsto pelo original de forma similar ao visto em \ref{fit_perfeito}.

\paragraph{}O passo seguinte desse trabalho será a definição da arquitetura utilizada pela rede neural. Devido à simplicidade e a boa capacidade de solução de problemas, foi utilizada a rede Perceptron Multicamadas com somente uma camada intermediária. Foi definido para a camada de entrada e intermediária que a função de ativação utilizada seria a ReLU, dado a velocidade de processamento e os bons resultados obtidos em pesquisas recentes \ref{reluSucesso}. 

\paragraph{}O treinamento será feito utilizando validação cruzada com 8 subconjuntos no conjunto de dados de treinamento. Serão deixados 3 pontos da série temporal para realizar o teste. Para cada subconjunto serão feitas 3 inicializações aleatórias utilizando o método chamado \textit{he uniform}, o qual está descrito em \cite{K_He}. Os 3 últimos elementos serão separados para teste e os outros 25 serão utilizados na validação cruzada. Após a extração residual, os dados serão normalizados para facilitar a convergência do treinamento, assim como mostrado em na seção \ref{treinamento_mlp}. 

\paragraph{}O algoritmo de aprendizado que será utilizado é o AdaDelta com learning rate de $\alpha = 0.01$ \cite{adadelta} por conta dos bons resultados obtidos no treinamento e rápida convergência para o estado final. Será utilizado o critério de parada antecipada \textit{early stop} para que caso a rede não melhore o erro obtido em 25 épocas, o processamento será então interrompido. Para a camada de saída, a função de ativação escolhida será a linear, para que se possa construir a série temporal

\paragraph{} Serão realizados treinamentos variando o número de neurônios entre 1 e 90, buscando obter o número de neurônios ideal na camada intermediária. O limite superior é arbitrariamente grande de formar a buscar que o melhor modelo esteja dentro desse intervalo. A partir disso, será gerado um gráfico com o RMSE pelo número de neurônios no conjunto de validação e de teste. 

\paragraph{}Para facilitar a seleção dos modelos, será feita uma tabela contendo informações sobre o erro médio, desvio padrão, coeficiente angular e offset médios para o conjunto de dados de validação. Sendo assim, será utilizada a métrica para medir o desvio do coeficiente angular ($a$) e do \textit{offset}($b$) de cada modelo, fazendo com que um primeiro erro seja obtido através da fórmula $\epsilon_1 = NORM(ABS(1-a))$ e um segundo seja obtido por $\epsilon_2 = NORM(ABS(b))$, onde $ABS$ é o valor absoluto do número. Além disso, para fins de ranqueamento, definiu-se uma terceira métrica descrita como $\epsilon_3 = \epsilon_1 + \epsilon_2$, onde $NORM$ é a normalização feita dividindo todos os valores pela norma infinita do vetor. O modelo a ser utilizado é então o que tiver o menor erro $\epsilon_3$.

\paragraph{}Na primeira fase do treinamento, será treinada uma rede, onde a entrada no mês atual, $x(t)$, será utilizada para estimar a saída para o mês atual, $y(t)$. Com isso será possível verificar se o processo utilizado no treinamento e seleção da rede está adequado ao problema e realizar os ajustes necessários. Além disso, essa rede servirá como caso base para os modelos de previsão. Dado que as previsões são somente variações desse modelo básico, torna-se de extrema importância a boa adesão do modelo ao problema. 

\paragraph{}A saída utilizada no processamento foi o sinal residual do PLD médio mensal, dado que a tendência, sazonalidade e ciclos sazonais são determinísticos. Sendo assim, para obter valor final da PLD é necessário combinar a parte prevista pela rede com a parte determinística.

\paragraph{}Da segunda fase em diante, foram feitas previsões do resíduo do PLD mensal de fato. Na segunda fase em específico, previu-se o resíduo PLD para o mês seguinte. Além disso, propôs-se uma abordagem com o treinamento de uma segunda rede neural para corrigir o erro entre a previsão feita pela primeira rede e o sinal original.

\paragraph{}Nos passos seguintes somente foi feita a comparação entre o resíduo original e o previsto para $N$ meses a frente. Ao final, será possível obter um gráfico com o erro e desvio padrão pela quantidade de meses a frente.

\paragraph{}Sendo assim, o diagrama que resume o modelo exposto nesse capítulo pode ser visto na figura \ref{esquematicoProcessamento}

\begin{figure}[H]
	\begin{center}
		{
			\begin{center}
				
				\includegraphics[width=\textwidth]{esquema_processamento_tcc.jpg}		
				\caption[\small{Diagrama do Método.}]{\label{esquematicoProcessamento} \small{Diagrama do Método.}}
				
			\end{center}
			
		}	
	\end{center}	
\end{figure}